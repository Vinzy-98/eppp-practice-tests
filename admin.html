<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - EPPP Practice Tests</title>
    <script>
        // Admin authentication - protect sensitive data
        // SHA-256 hash of admin password
        const ADMIN_PASSWORD_HASH = "37b359e44e7aa0375fa71e08b3b834c41cd63fb6193348fe6acaaeaabc1193ef";
        
        function hashPassword(password) {
            // Simple SHA-256 implementation
            return crypto.subtle.digest('SHA-256', new TextEncoder().encode(password))
                .then(hash => Array.from(new Uint8Array(hash))
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join(''));
        }
        
        async function checkAdminAuth() {
            const authenticated = sessionStorage.getItem('admin_authenticated');
            
            if (authenticated === 'true') {
                return true;
            }
            
            const password = prompt('Admin Dashboard Access Required\n\nEnter admin password:');
            
            if (!password) {
                alert('Access denied. Admin password required.');
                window.location.href = 'index.html';
                return false;
            }
            
            const hash = await hashPassword(password);
            
            if (hash === ADMIN_PASSWORD_HASH) {
                sessionStorage.setItem('admin_authenticated', 'true');
                return true;
            } else {
                alert('Incorrect admin password. Access denied.');
                window.location.href = 'index.html';
                return false;
            }
        }
        
        // Check authentication before loading page
        checkAdminAuth().then(authorized => {
            if (!authorized) {
                document.body.innerHTML = '';
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            color: #667eea;
            font-size: 32px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        }

        .stat-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .stat-value {
            font-size: 42px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 16px;
            color: #666;
            font-weight: 500;
        }

        .content-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 24px;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 18px;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .export-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .header {
                text-align: center;
            }

            .header h1 {
                font-size: 24px;
                justify-content: center;
            }

            .header-actions {
                width: 100%;
                justify-content: center;
            }

            .chart-container {
                height: 300px;
            }

            table {
                font-size: 14px;
            }

            th, td {
                padding: 10px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <span>üìä</span>
                Admin Dashboard
            </h1>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="refreshData()">üîÑ Refresh</button>
                <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
                <a href="index.html" class="btn btn-primary">‚Üê Back to Home</a>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üë•</div>
                <div class="stat-value" id="uniqueUsersCount">0</div>
                <div class="stat-label">Unique Users</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">üîê</div>
                <div class="stat-value" id="totalAccessCount">0</div>
                <div class="stat-label">Total Accesses</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">üìù</div>
                <div class="stat-value" id="totalTestsCount">0</div>
                <div class="stat-label">Tests Taken</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">üìà</div>
                <div class="stat-value" id="avgScore">0%</div>
                <div class="stat-label">Average Score</div>
            </div>
        </div>

        <div class="content-section">
            <h2 class="section-title">üìÖ Access Over Time</h2>
            <div class="chart-container">
                <canvas id="accessChart"></canvas>
            </div>
        </div>

        <div class="content-section">
            <h2 class="section-title">üìä Test Performance Overview</h2>
            <div class="chart-container">
                <canvas id="performanceChart"></canvas>
            </div>
        </div>

        <div class="content-section">
            <h2 class="section-title">üîê Recent Access Logs</h2>
            <table id="accessLogsTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Session ID</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="accessLogsBody">
                    <tr>
                        <td colspan="5" class="no-data">No access logs available</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="content-section">
            <h2 class="section-title">üë§ User Activity Summary</h2>
            <table id="userActivityTable">
                <thead>
                    <tr>
                        <th>User Name</th>
                        <th>Email</th>
                        <th>Tests Taken</th>
                        <th>Avg Score</th>
                        <th>Last Activity</th>
                    </tr>
                </thead>
                <tbody id="userActivityBody">
                    <tr>
                        <td colspan="5" class="no-data">No user activity available</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="export-section">
            <div>
                <strong>üì• Export Data</strong>
                <p style="color: #666; font-size: 14px; margin-top: 5px;">Download all analytics data for backup or analysis</p>
            </div>
            <div>
                <button class="btn btn-primary" onclick="exportToJSON()">üìÑ Export as JSON</button>
                <button class="btn btn-secondary" onclick="exportToCSV()">üìä Export as CSV</button>
            </div>
        </div>
    </div>

    <script>
        let accessChart, performanceChart;

        // Initialize dashboard on load
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
        });

        function loadDashboardData() {
            // Load statistics
            loadStatistics();
            
            // Load charts
            loadAccessChart();
            loadPerformanceChart();
            
            // Load tables
            loadAccessLogs();
            loadUserActivity();
        }

        function loadStatistics() {
            // Unique users (sessions)
            const uniqueSessions = JSON.parse(localStorage.getItem('eppp_unique_sessions') || '{}');
            const uniqueUsersCount = Object.keys(uniqueSessions).length;
            document.getElementById('uniqueUsersCount').textContent = uniqueUsersCount;

            // Total accesses
            const accessLogs = JSON.parse(localStorage.getItem('eppp_access_logs') || '[]');
            document.getElementById('totalAccessCount').textContent = accessLogs.length;

            // Total tests and average score
            let totalTests = 0;
            let totalScore = 0;
            let scoreCount = 0;

            // Aggregate all user data
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('eppp_user_') && key.endsWith('_tests')) {
                    const userData = JSON.parse(localStorage.getItem(key));
                    if (userData && Array.isArray(userData)) {
                        totalTests += userData.length;
                        userData.forEach(test => {
                            if (test.score !== undefined) {
                                totalScore += test.score;
                                scoreCount++;
                            }
                        });
                    }
                }
            }

            document.getElementById('totalTestsCount').textContent = totalTests;
            
            const avgScore = scoreCount > 0 ? (totalScore / scoreCount).toFixed(1) : 0;
            document.getElementById('avgScore').textContent = avgScore + '%';
        }

        function loadAccessChart() {
            const accessLogs = JSON.parse(localStorage.getItem('eppp_access_logs') || '[]');
            
            // Group by date
            const dateGroups = {};
            accessLogs.forEach(log => {
                const date = log.date || new Date(log.timestamp).toLocaleDateString();
                dateGroups[date] = (dateGroups[date] || 0) + 1;
            });

            // Sort dates
            const sortedDates = Object.keys(dateGroups).sort((a, b) => new Date(a) - new Date(b));
            const last7Days = sortedDates.slice(-7);
            
            const data = {
                labels: last7Days.length > 0 ? last7Days : ['No Data'],
                datasets: [{
                    label: 'Access Count',
                    data: last7Days.length > 0 ? last7Days.map(date => dateGroups[date]) : [0],
                    backgroundColor: 'rgba(102, 126, 234, 0.2)',
                    borderColor: 'rgba(102, 126, 234, 1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            };

            const ctx = document.getElementById('accessChart').getContext('2d');
            if (accessChart) accessChart.destroy();
            
            accessChart = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function loadPerformanceChart() {
            // Collect test scores by test name
            const testScores = {};
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('eppp_user_') && key.endsWith('_tests')) {
                    const userData = JSON.parse(localStorage.getItem(key));
                    if (userData && Array.isArray(userData)) {
                        userData.forEach(test => {
                            if (test.testName && test.score !== undefined) {
                                if (!testScores[test.testName]) {
                                    testScores[test.testName] = [];
                                }
                                testScores[test.testName].push(test.score);
                            }
                        });
                    }
                }
            }

            // Calculate average scores per test
            const testNames = Object.keys(testScores).sort().slice(0, 10); // Top 10 tests
            const avgScores = testNames.map(name => {
                const scores = testScores[name];
                return scores.reduce((a, b) => a + b, 0) / scores.length;
            });

            const data = {
                labels: testNames.length > 0 ? testNames : ['No Data'],
                datasets: [{
                    label: 'Average Score (%)',
                    data: avgScores.length > 0 ? avgScores : [0],
                    backgroundColor: 'rgba(118, 75, 162, 0.6)',
                    borderColor: 'rgba(118, 75, 162, 1)',
                    borderWidth: 2
                }]
            };

            const ctx = document.getElementById('performanceChart').getContext('2d');
            if (performanceChart) performanceChart.destroy();
            
            performanceChart = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        function loadAccessLogs() {
            const accessLogs = JSON.parse(localStorage.getItem('eppp_access_logs') || '[]');
            const tbody = document.getElementById('accessLogsBody');
            
            if (accessLogs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="no-data">No access logs available</td></tr>';
                return;
            }

            // Show last 50 logs
            const recentLogs = accessLogs.slice(-50).reverse();
            
            tbody.innerHTML = recentLogs.map((log, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${log.date || new Date(log.timestamp).toLocaleDateString()}</td>
                    <td>${log.time || new Date(log.timestamp).toLocaleTimeString()}</td>
                    <td><span class="badge badge-info">${log.sessionId.substring(0, 8)}</span></td>
                    <td><span class="badge badge-success">Authenticated</span></td>
                </tr>
            `).join('');
        }

        function loadUserActivity() {
            const tbody = document.getElementById('userActivityBody');
            const userActivities = [];

            // Collect all user data
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('eppp_user_') && key.endsWith('_tests')) {
                    const email = key.replace('eppp_user_', '').replace('_tests', '');
                    const userData = JSON.parse(localStorage.getItem(key));
                    const userInfo = JSON.parse(localStorage.getItem(`eppp_user_${email}`) || '{}');
                    
                    if (userData && Array.isArray(userData)) {
                        const scores = userData.map(t => t.score).filter(s => s !== undefined);
                        const avgScore = scores.length > 0 ? (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1) : 'N/A';
                        const lastTest = userData.length > 0 ? userData[userData.length - 1] : null;
                        
                        userActivities.push({
                            name: userInfo.name || 'Unknown',
                            email: email,
                            testsTaken: userData.length,
                            avgScore: avgScore,
                            lastActivity: lastTest ? new Date(lastTest.completedAt).toLocaleDateString() : 'N/A'
                        });
                    }
                }
            }

            if (userActivities.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="no-data">No user activity available</td></tr>';
                return;
            }

            tbody.innerHTML = userActivities.map(user => `
                <tr>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td><span class="badge badge-info">${user.testsTaken}</span></td>
                    <td><span class="badge badge-${user.avgScore >= 70 ? 'success' : 'warning'}">${user.avgScore}${typeof user.avgScore === 'number' ? '%' : ''}</span></td>
                    <td>${user.lastActivity}</td>
                </tr>
            `).join('');
        }

        function refreshData() {
            loadDashboardData();
            alert('Dashboard data refreshed!');
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è WARNING: This will delete ALL user data, access logs, and test results. This action cannot be undone!\n\nAre you absolutely sure?')) {
                if (confirm('This is your final confirmation. Delete everything?')) {
                    // Clear all EPPP-related localStorage
                    const keysToRemove = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key.startsWith('eppp_')) {
                            keysToRemove.push(key);
                        }
                    }
                    
                    keysToRemove.forEach(key => localStorage.removeItem(key));
                    
                    alert('All data has been cleared.');
                    loadDashboardData();
                }
            }
        }

        function exportToJSON() {
            const data = {
                exported: new Date().toISOString(),
                statistics: {
                    uniqueUsers: document.getElementById('uniqueUsersCount').textContent,
                    totalAccesses: document.getElementById('totalAccessCount').textContent,
                    totalTests: document.getElementById('totalTestsCount').textContent,
                    avgScore: document.getElementById('avgScore').textContent
                },
                accessLogs: JSON.parse(localStorage.getItem('eppp_access_logs') || '[]'),
                uniqueSessions: JSON.parse(localStorage.getItem('eppp_unique_sessions') || '{}'),
                users: []
            };

            // Collect user data
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('eppp_user_') && key.endsWith('_tests')) {
                    const email = key.replace('eppp_user_', '').replace('_tests', '');
                    const userData = JSON.parse(localStorage.getItem(key));
                    const userInfo = JSON.parse(localStorage.getItem(`eppp_user_${email}`) || '{}');
                    
                    data.users.push({
                        name: userInfo.name,
                        email: email,
                        tests: userData
                    });
                }
            }

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `eppp-admin-data-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportToCSV() {
            // Export user activity as CSV
            const rows = [['Name', 'Email', 'Tests Taken', 'Average Score', 'Last Activity']];

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('eppp_user_') && key.endsWith('_tests')) {
                    const email = key.replace('eppp_user_', '').replace('_tests', '');
                    const userData = JSON.parse(localStorage.getItem(key));
                    const userInfo = JSON.parse(localStorage.getItem(`eppp_user_${email}`) || '{}');
                    
                    if (userData && Array.isArray(userData)) {
                        const scores = userData.map(t => t.score).filter(s => s !== undefined);
                        const avgScore = scores.length > 0 ? (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1) : 'N/A';
                        const lastTest = userData.length > 0 ? userData[userData.length - 1] : null;
                        
                        rows.push([
                            userInfo.name || 'Unknown',
                            email,
                            userData.length,
                            avgScore,
                            lastTest ? new Date(lastTest.completedAt).toLocaleDateString() : 'N/A'
                        ]);
                    }
                }
            }

            const csv = rows.map(row => row.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `eppp-user-activity-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
